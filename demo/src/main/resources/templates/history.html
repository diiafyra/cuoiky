<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<th:block th:replace="~{layouts/main :: layout(
  title=~{::title},
  styles=~{::link[@data-page='style']},
  content=~{::section[@data-page='content']},
  scripts=~{::script[@data-page='script']}
)}">
  <head>
    <title>Lịch sử gợi ý • Moodsic</title>
    <!-- Reuse base + card styles của Home -->
    <link data-page="style" rel="stylesheet" href="/css/home/index.css"/>
    <!-- Page-specific -->
    <link data-page="style" rel="stylesheet" href="/css/history/index.css"/>
  </head>

  <body>
    <section data-page="content" class="container section">
      <header class="history-head glass">
        <div>
          <h2>Lịch sử gợi ý</h2>
          <small class="muted" th:text="${uid}">anonymous</small>
        </div>
        <span class="pill" th:text="${items != null ? items.size() + ' phiên' : '0 phiên'}">0 phiên</span>
      </header>

      <div th:if="${items == null or #lists.isEmpty(items)}" class="empty">
        Chưa có lịch sử. Hãy thử gợi ý từ trang Home.
      </div>

      <!-- Grid -->
      <section class="h-grid" th:if="${items != null and !#lists.isEmpty(items)}">
        <!-- Mỗi item là 1 <a> để điều hướng thẳng, không cần JS -->
        <a class="h-card" th:each="it : ${items}"
           th:href="@{'/recommend/' + ${it.id}}"
           th:title="${it.moodText}">
          <div class="h-cover">
            <img th:src="${it.imageUrl != null ? it.imageUrl : '/img/cover-fallback.png'}"
                 th:alt="${it.moodText != null ? it.moodText : 'mood canvas'}"/>
            <div class="h-badges">
              <span class="badge" th:text="${it.totalPlaylists != null ? it.totalPlaylists + ' playlists' : '—'}">—</span>
            </div>
          </div>

          <div class="h-meta">
            <h3 th:text="${#strings.abbreviate(it.moodText != null ? it.moodText : '—', 60)}">—</h3>
            <small class="muted"
                   th:text="${#temporals.format(it.createdAt, 'dd MMM yyyy, HH:mm')}">—</small>

            <!-- keywords: hiển thị tối đa 3 chip -->
            <div class="chips" th:if="${it.keywords != null and !#lists.isEmpty(it.keywords)}">
              <span class="chip"
                    th:each="kw, iStat : ${it.keywords}"
                    th:if="${iStat.index < 3}"
                    th:text="${kw}">kw</span>
              <span class="chip muted"
                    th:if="${#lists.size(it.keywords) > 3}"
                    th:text="${'+' + (#lists.size(it.keywords) - 3)}">+N</span>
            </div>
          </div>
        </a>
      </section>
    </section>

    <!-- Không cần JS nếu chỉ click card để đi tới /recommend/{id} -->
    <script data-page="script" type="module" src="/js/history/index.js"></script>
  </body>
</th:block>
</html>
